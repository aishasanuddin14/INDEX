<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Laporan Ormas Halteng – Live dari Excel</title>

  <!-- UI & Tabel -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <!-- DataTables Responsive (BIAR MOBILE BENERAN) -->
  <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">

  <!-- Peta -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    body{background:#f7f7fb}
    .mini{font-size:.9rem;color:#6b7280}
    .card-stat{border:0;border-radius:1rem}
    .card-stat .display-6{font-weight:700}
    #map{height:520px;border-radius:1rem}
    .badge-pin{background:#2563eb;color:#fff;border-radius:999px;padding:.35rem .6rem;border:2px solid #1e40af;box-shadow:0 2px 6px rgba(0,0,0,.2);font-weight:700;font-size:.9rem;line-height:1;text-align:center}
    .badge-pin.red{background:#dc2626;border-color:#991b1b}
    .badge-pin.green{background:#16a34a;border-color:#166534}
    .legend{background:#fff;padding:.5rem .75rem;border-radius:.5rem;box-shadow:0 1px 6px rgba(0,0,0,.1)}
    .legend .dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:.35rem}
    .legend .dot.green{background:#16a34a}
    .legend .dot.red{background:#dc2626}
    .legend .dot.blue{background:#2563eb}

    /* badge filter click-ability */
    .filter-badge{display:inline-block;cursor:pointer; user-select:none}
    .filter-badge.active{outline:2px solid #111; box-shadow:0 0 0 2px rgba(0,0,0,.08) inset}
  </style>
</head>
<body>
  <div class="container py-4">
    <header class="mb-3 text-center">
      <h1 class="fw-bold">Laporan Ormas, Paguyuban, dan Lembaga – Halmahera Tengah</h1>
      <p class="text-muted">Data dibaca langsung dari <code>data/master_ormas.xlsx</code>. Ganti Excel, commit, refresh halaman, selesai.</p>
    </header>

    <!-- BADGES (klik untuk filter tabel) -->
    <section class="mb-4">
      <div class="row g-3 text-center">
        <div class="col-6 col-md-2">
          <span class="badge bg-primary p-3 w-100 filter-badge active" data-mode="all" title="Tampilkan semua">
            Total Ormas<br><span id="bTotal" class="fs-5">0</span>
          </span>
        </div>
        <div class="col-6 col-md-2">
          <span class="badge bg-success p-3 w-100 filter-badge" data-mode="aktif" title="Hanya yang aktif">
            Aktif<br><span id="bAktif" class="fs-5">0</span>
          </span>
        </div>
        <div class="col-6 col-md-2">
          <span class="badge bg-danger p-3 w-100 filter-badge" data-mode="nonaktif" title="Hanya yang tidak aktif">
            Tidak Aktif<br><span id="bNon" class="fs-5">0</span>
          </span>
        </div>
        <div class="col-6 col-md-2">
          <span class="badge bg-warning text-dark p-3 w-100 filter-badge" data-mode="skt" title="Punya SKT/Kemenkumham/Terdaftar">
            SKT/Kemenkumham<br><span id="bSKT" class="fs-5">0</span>
          </span>
        </div>
        <div class="col-6 col-md-2">
          <span class="badge bg-info text-dark p-3 w-100 filter-badge" data-mode="nasional" title="Lingkup Nasional">
            Nasional<br><span id="bNas" class="fs-5">0</span>
          </span>
        </div>
        <div class="col-6 col-md-2">
          <span class="badge bg-secondary p-3 w-100 filter-badge" data-mode="lokal" title="Lingkup Lokal/Daerah">
            Lokal/Daerah<br><span id="bLok" class="fs-5">0</span>
          </span>
        </div>
      </div>
    </section>

    <!-- MAP -->
    <section class="mb-4">
      <div class="card shadow-sm p-3">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="mb-3">Sebaran pada Peta (angka = jumlah ormas per titik)</h6>
          <div class="legend">
            <div class="mini mb-1"><strong>Keterangan:</strong></div>
            <div><span class="dot blue"></span> Jumlah ormas per lokasi</div>
            <div><span class="dot green"></span> Proporsi aktif ≥ 60%</div>
            <div><span class="dot red"></span> Proporsi aktif &lt; 60%</div>
          </div>
        </div>
        <div id="map"></div>
        <div id="tip" class="alert alert-warning mt-2 d-none">
          Tidak ada marker. Pastikan kolom <strong>Latitude</strong> dan <strong>Longitude</strong> terisi di Excel.
        </div>
      </div>
    </section>

    <!-- TABLE -->
    <section class="mb-4" id="tableSection">
      <div class="card shadow-sm p-3">
        <!-- Catatan: DataTables Responsive sudah menangani responsif,
             kalau double-scroll, hapus wrapper .table-responsive ini -->
        <div class="table-responsive">
          <table id="ormasTable" class="table table-striped table-bordered w-100 dt-responsive nowrap">
            <thead class="table-light"><tr id="tblHead"></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <footer class="py-3 text-center"><small>© 2025 Kesbangpol Halmahera Tengah | Live Excel.</small></footer>
  </div>

  <!-- Libs -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <!-- DataTables Responsive (JS) -->
  <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- SheetJS: baca Excel di browser -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // ===== KONFIG =====
    const EXCEL_PATH = "data/master_ormas.xlsx"; // ganti hanya jika nama file/letak berbeda

    // ===== HEADER YANG DIDUKUNG =====
    // Kamu boleh pakai variasi nama kolom berikut. Script akan memetakan otomatis.
    const HEADER_MAP = {
      "No":["No","Nomor","ID"],
      "Nama Ormas/Lembaga": [
  "Nama Ormas/Lembaga",
  "Nama Ormas",
  "Nama Lembaga",
  "Nama",
  "Organisasi",
  "Nama Organisasi"
],

      "Ketua/PJ":["Ketua/PJ","Ketua","Penanggung Jawab","PJ"],
      "Kontak":["Kontak","HP","No HP","Telepon","Telp","Phone"],
      "Status":["Status","Status Aktif"],
      "Kantor/Sekretariat":["Kantor/Sekretariat","Alamat","Desa","Lokasi"],
      "Jenis/Fokus":["Jenis/Fokus","Kategori","Fokus","Jenis"],
      "Legalitas":["Legalitas","Badan Hukum"],
      "Status Pendaftaran":["Status Pendaftaran","SKT","Kemenkumham","Registrasi"],
      "Lingkup":["Lingkup","Skala","Cakupan"],
      "Metode Verifikasi":["Metode Verifikasi","Verifikasi","Sumber"],
      "Kegiatan":["Kegiatan","Aktivitas","Catatan"],
      "Latitude":["Latitude","Lat","Lintang","Koordinat Latitude"],
      "Longitude":["Longitude","Lng","Bujur","Koordinat Longitude"]
    };
    const EXPECTED_COLS = Object.keys(HEADER_MAP);

    // ===== UTIL =====
    const toNum = (x)=>{
      if(x==null) return NaN;
      const s = String(x).trim().replace(",", ".").replace(/[^0-9.\-]+/g,"");
      const v = parseFloat(s);
      return isNaN(v)?NaN:v;
    };
    const isActive = (status)=>{
      if(!status) return false;
      const s = String(status).toLowerCase();
      return s.includes("aktif") && !s.includes("tidak");
    };

    // Peta Excel -> header standar
    function normalizeRow(rowRaw){
      const row = {};
      for(const std of EXPECTED_COLS){
        const alts = HEADER_MAP[std];
        let found="";
        for(const k of Object.keys(rowRaw)){
          const key = String(k).trim();
          if(alts.some(a=>a.toLowerCase()===key.toLowerCase())){ found = key; break; }
        }
        row[std] = found ? rowRaw[found] : "";
      }
      return row;
    }

    // Group per lokasi
    function groupByLocation(rows){
      const groups = {};
      rows.forEach(r=>{
        let lat = toNum(r["Latitude"]);
        let lng = toNum(r["Longitude"]);
        // auto swap jika kebalik
        if(!isNaN(lat) && !isNaN(lng) && Math.abs(lat)>20 && Math.abs(lng)<5){ const t=lat; lat=lng; lng=t; }
        if(isNaN(lat) || isNaN(lng)) return;
        const key = lat.toFixed(5)+","+lng.toFixed(5);
        if(!groups[key]) groups[key] = {lat, lng, desa: r["Kantor/Sekretariat"]||"-", items:[]};
        groups[key].items.push(r);
      });
      return groups;
    }

    // ===== LOAD EXCEL =====
    async function loadExcel(){
      const url = EXCEL_PATH + "?v=" + Date.now(); // cache-buster
      const resp = await fetch(url);
      if(!resp.ok) throw new Error("Gagal mengambil Excel: "+resp.status);
      const buf = await resp.arrayBuffer();
      const wb = XLSX.read(buf, {type:"array"});
      const sheet = wb.Sheets[wb.SheetNames[0]];
      let rows = XLSX.utils.sheet_to_json(sheet, {defval:""});
      rows = rows.map(normalizeRow);
      return rows;
    }

    // ===== RENDER BADGES =====
    function renderBadges(rows){
      const total = rows.length;
      const aktif = rows.filter(r=>isActive(r["Status"])).length;
      const non = rows.filter(r=>(r["Status"]||"").toLowerCase().includes("tidak")).length;
      const skt = rows.filter(r=>{
        const p=(r["Status Pendaftaran"]||"").toLowerCase();
        return p.includes("skt")||p.includes("kemenkumham")||p.includes("terdaftar");
      }).length;
      const nas = rows.filter(r=>(r["Lingkup"]||"").toLowerCase().includes("nasional")).length;
      const lok = rows.filter(r=>{
        const l=(r["Lingkup"]||"").toLowerCase();
        return l.includes("lokal")||l.includes("daerah");
      }).length;
      document.getElementById("bTotal").innerText=total;
      document.getElementById("bAktif").innerText=aktif;
      document.getElementById("bNon").innerText=non;
      document.getElementById("bSKT").innerText=skt;
      document.getElementById("bNas").innerText=nas;
      document.getElementById("bLok").innerText=lok;
    }

    // ===== RENDER MAP =====
    function renderMap(rows){
      const groups = groupByLocation(rows);
      const keys = Object.keys(groups);
      const map = L.map('map').setView([-0.3245,127.8880],10);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18,attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
      if(!keys.length){ document.getElementById('tip').classList.remove('d-none'); return; }

      const layer = L.layerGroup().addTo(map);
      const bounds = [];
      keys.forEach(k=>{
        const g = groups[k];
        const aktif = g.items.filter(i=>isActive(i["Status"])).length;
        const ratio = aktif / g.items.length;
        const pinClass = ratio>=0.6 ? "badge-pin green" : (ratio>0 ? "badge-pin red" : "badge-pin");
        const icon = L.divIcon({html:"<div class='"+pinClass+"'>"+g.items.length+"</div>",className:"",iconSize:[36,36],iconAnchor:[18,18]});
        const m = L.marker([g.lat,g.lng],{icon}).addTo(layer);
        const list = g.items.slice(0,12).map(i=>"• "+(i["Nama Ormas/Lembaga"]||"-")+" ("+(i["Status"]||"-")+")").join("<br/>");
        const more = g.items.length>12 ? "<br/><em>+"+(g.items.length-12)+" lainnya…</em>" : "";
        m.bindPopup("<strong>"+(g.desa||"Lokasi")+"</strong><br/>Koordinat: "+g.lat.toFixed(6)+", "+g.lng.toFixed(6)+"<br/>Total ormas: <strong>"+g.items.length+"</strong><hr/>"+list+more);
        bounds.push([g.lat,g.lng]);
      });
      if(bounds.length) map.fitBounds(L.latLngBounds(bounds),{padding:[20,20]});
    }

    // ===== TABEL (DataTables) =====
    let DT = null, ALL_ROWS = [];

    function buildHeader(){
      const head = document.getElementById("tblHead"); head.innerHTML="";
      EXPECTED_COLS.forEach(c=>{ const th=document.createElement("th"); th.textContent=c; head.appendChild(th); });
    }

    function renderTable(rows){
      buildHeader();
      const data = rows.map(r=>EXPECTED_COLS.map(c=>r[c]||""));

      if (!DT) {
        DT = $('#ormasTable').DataTable({
          data,
          pageLength: 25,
          order: [[0,'asc']],
          responsive: true,        // kunci responsif
          autoWidth: false,
          columnDefs: [
            { responsivePriority: 1, targets: [1] },            // Nama Ormas/Lembaga
            { responsivePriority: 2, targets: [4] },            // Status
            { responsivePriority: 3, targets: [5] },            // Kantor/Sekretariat (desa)
            { responsivePriority: 10001, targets: [12,13] }     // Latitude, Longitude disembunyikan dulu di HP
          ]
        });
      } else {
        DT.clear().rows.add(data).draw();
        DT.columns.adjust().responsive.recalc();
      }
    }

    // ===== FILTERING BERDASAR BADGE =====
    function filterRows(mode){
      if(!ALL_ROWS || !ALL_ROWS.length) return [];
      const rows = ALL_ROWS;
      switch(mode){
        case "aktif":
          return rows.filter(r=>isActive(r["Status"]));
        case "nonaktif":
          return rows.filter(r=>(r["Status"]||"").toLowerCase().includes("tidak"));
        case "skt":
          return rows.filter(r=>{
            const p=(r["Status Pendaftaran"]||"").toLowerCase();
            return p.includes("skt")||p.includes("kemenkumham")||p.includes("terdaftar");
          });
        case "nasional":
          return rows.filter(r=>(r["Lingkup"]||"").toLowerCase().includes("nasional"));
        case "lokal":
          return rows.filter(r=>{
            const l=(r["Lingkup"]||"").toLowerCase();
            return l.includes("lokal")||l.includes("daerah");
          });
        default: // "all"
          return rows;
      }
    }

    // === FIX: event delegation utk klik badge (anti-ngadat)
    document.addEventListener('click', function(e){
      const el = e.target.closest('.filter-badge');
      if(!el) return;
      e.preventDefault();

      const mode = el.dataset.mode || 'all';
      // set state visual active
      document.querySelectorAll('.filter-badge').forEach(b=>{
        b.classList.toggle('active', b === el);
      });

      // filter data lalu render ulang tabel
      const subset = filterRows(mode);
      renderTable(subset);

      // scroll ke tabel biar jelas berubah
      const sec = document.getElementById('tableSection');
      if(sec) sec.scrollIntoView({behavior:'smooth', block:'start'});
    }, {passive:true});

    // ===== BOOT =====
    (async function(){
      try{
        const rows = await loadExcel();
        ALL_ROWS = rows.slice();
        renderBadges(rows);
        renderMap(rows);
        renderTable(rows);       // default: semua
      }catch(e){
        console.error(e);
        document.getElementById('tip').classList.remove('d-none');
        document.getElementById('tip').classList.replace('alert-warning','alert-danger');
        document.getElementById('tip').innerHTML = "Gagal memuat Excel. Pastikan file ada di <code>"+EXCEL_PATH+"</code> di repo ini.";
      }
    })();
    let DT = null; // pastikan global

function renderTable(rows){
  // rebuild header DOM biar sinkron
  const head = document.getElementById("tblHead");
  head.innerHTML = "";
  EXPECTED_COLS.forEach(c=>{
    const th = document.createElement("th");
    th.textContent = c;
    head.appendChild(th);
  });

  // siapkan data berurutan + fallback
  const data = rows.map((r, idx) => {
    const row = EXPECTED_COLS.map(c => {
      let val = r[c];
      if (val === undefined || val === null || String(val).trim() === "") return "-";
      return val;
    });
    // kolom "No" auto diisi jika kosong
    const noIdx = EXPECTED_COLS.indexOf("No");
    if (noIdx >= 0 && (row[noIdx] === "-" || row[noIdx] === "")) {
      row[noIdx] = idx + 1;
    }
    return row;
  });

  // definisi kolom eksplisit agar DataTables tidak sok tau
  const columns = EXPECTED_COLS.map(c => ({ title: c }));

  if (!DT) {
    DT = $('#ormasTable').DataTable({
      data,
      columns,
      pageLength: 25,
      order: [[0, 'asc']],
      responsive: true,
      autoWidth: false,
      columnDefs: [
        { responsivePriority: 1, targets: [EXPECTED_COLS.indexOf("Nama Ormas/Lembaga")] },
        { responsivePriority: 2, targets: [EXPECTED_COLS.indexOf("Status")] },
        { responsivePriority: 3, targets: [EXPECTED_COLS.indexOf("Kantor/Sekretariat")] },
        { responsivePriority: 10001, targets: [
            EXPECTED_COLS.indexOf("Latitude"),
            EXPECTED_COLS.indexOf("Longitude")
          ].filter(i => i >= 0)
        }
      ],
      language: {
        search: "Cari:",
        lengthMenu: "Tampilkan _MENU_ entri",
        zeroRecords: "Tidak ada data",
        info: "Menampilkan _START_–_END_ dari _TOTAL_",
        infoEmpty: "Tidak ada data",
        infoFiltered: "(disaring dari _MAX_ total data)"
      }
    });
  } else {
    DT.clear().rows.add(data).draw();
    DT.columns.adjust().responsive.recalc();
  }
}
function renderTable(rows, filterType="all"){
  let filtered = rows;

  if(filterType==="aktif"){
    filtered = rows.filter(r=>isActive(r["Status"]));
  }else if(filterType==="non"){
    filtered = rows.filter(r=>(r["Status"]||"").toLowerCase().includes("tidak"));
  }else if(filterType==="skt"){
    filtered = rows.filter(r=>{
      const p=(r["Status Pendaftaran"]||"").toLowerCase();
      return p.includes("skt")||p.includes("kemenkumham")||p.includes("terdaftar");
    });
  }else if(filterType==="nas"){
    filtered = rows.filter(r=>(r["Lingkup"]||"").toLowerCase().includes("nasional"));
  }else if(filterType==="lok"){
    filtered = rows.filter(r=>{
      const l=(r["Lingkup"]||"").toLowerCase();
      return l.includes("lokal")||l.includes("daerah");
    });
  }

  // isi tabel
  const head = document.getElementById("tblHead");
  head.innerHTML = "";
  EXPECTED_COLS.forEach(c=>{
    const th=document.createElement("th");
    th.textContent=c;
    head.appendChild(th);
  });

  const data = filtered.map((r,i)=>EXPECTED_COLS.map(c=>r[c]||"-"));

  $('#ormasTable').DataTable({
    destroy:true,
    data,
    columns: EXPECTED_COLS.map(c=>({title:c})),
    pageLength:25,
    responsive:true
  });
}
document.querySelector('[id="bAktif"]').parentElement.onclick = ()=>renderTable(rows,"aktif");
document.querySelector('[id="bNon"]').parentElement.onclick = ()=>renderTable(rows,"non");
document.querySelector('[id="bSKT"]').parentElement.onclick = ()=>renderTable(rows,"skt");
document.querySelector('[id="bNas"]').parentElement.onclick = ()=>renderTable(rows,"nas");
document.querySelector('[id="bLok"]').parentElement.onclick = ()=>renderTable(rows,"lok");
document.querySelector('[id="bTotal"]').parentElement.onclick = ()=>renderTable(rows,"all");


  </script>
  
</body>
</html>
