<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Laporan Ormas Halteng – Live dari Excel</title>

  <!-- UI & Tabel -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">

  <!-- Peta -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    body{background:#f7f7fb}
    .mini{font-size:.9rem;color:#6b7280}
    .card-stat{border:0;border-radius:1rem}
    .card-stat .display-6{font-weight:700}
    #map{height:520px;border-radius:1rem}
    .badge-pin{background:#2563eb;color:#fff;border-radius:999px;padding:.35rem .6rem;border:2px solid #1e40af;box-shadow:0 2px 6px rgba(0,0,0,.2);font-weight:700;font-size:.9rem;line-height:1;text-align:center}
    .badge-pin.red{background:#dc2626;border-color:#991b1b}
    .badge-pin.green{background:#16a34a;border-color:#166534}
    .legend{background:#fff;padding:.5rem .75rem;border-radius:.5rem;box-shadow:0 1px 6px rgba(0,0,0,.1)}
    .legend .dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:.35rem}
    .legend .dot.green{background:#16a34a}
    .legend .dot.red{background:#dc2626}
    .legend .dot.blue{background:#2563eb}
  </style>
</head>
<body>
  <div class="container py-4">
    <header class="mb-3 text-center">
      <h1 class="fw-bold">Laporan Ormas, Paguyuban, dan Lembaga – Halmahera Tengah</h1>
      <p class="text-muted">Data dibaca langsung dari <code>data/master_ormas.xlsx</code>. Ganti Excel, commit, refresh halaman, selesai.</p>
    </header>

    <!-- BADGES -->
    <section class="mb-4">
      <div class="row g-3 text-center">
        <div class="col-6 col-md-2"><span class="badge bg-primary p-3 w-100">Total Ormas<br><span id="bTotal" class="fs-5">0</span></span></div>
        <div class="col-6 col-md-2"><span class="badge bg-success p-3 w-100">Aktif<br><span id="bAktif" class="fs-5">0</span></span></div>
        <div class="col-6 col-md-2"><span class="badge bg-danger p-3 w-100">Tidak Aktif<br><span id="bNon" class="fs-5">0</span></span></div>
        <div class="col-6 col-md-2"><span class="badge bg-warning text-dark p-3 w-100">SKT/Kemenkumham<br><span id="bSKT" class="fs-5">0</span></span></div>
        <div class="col-6 col-md-2"><span class="badge bg-info text-dark p-3 w-100">Nasional<br><span id="bNas" class="fs-5">0</span></span></div>
        <div class="col-6 col-md-2"><span class="badge bg-secondary p-3 w-100">Lokal/Daerah<br><span id="bLok" class="fs-5">0</span></span></div>
      </div>
    </section>

    <!-- MAP -->
    <section class="mb-4">
      <div class="card shadow-sm p-3">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="mb-3">Sebaran pada Peta (angka = jumlah ormas per titik)</h6>
          <div class="legend">
            <div class="mini mb-1"><strong>Keterangan:</strong></div>
            <div><span class="dot blue"></span> Jumlah ormas per lokasi</div>
            <div><span class="dot green"></span> Proporsi aktif ≥ 60%</div>
            <div><span class="dot red"></span> Proporsi aktif &lt; 60%</div>
          </div>
        </div>
        <div id="map"></div>
        <div id="tip" class="alert alert-warning mt-2 d-none">
          Tidak ada marker. Pastikan kolom <strong>Latitude</strong> dan <strong>Longitude</strong> terisi di Excel.
        </div>
      </div>
    </section>

    <!-- TABLE -->
    <section class="mb-4">
      <div class="card shadow-sm p-3">
        <div class="table-responsive">
          <table id="ormasTable" class="table table-striped table-bordered w-100">
            <thead class="table-light"><tr id="tblHead"></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <footer class="py-3 text-center"><small>© 2025 Kesbangpol Halmahera Tengah | Live Excel.</small></footer>
  </div>

  <!-- Libs -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- SheetJS: baca Excel di browser -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // ===== KONFIG =====
    const EXCEL_PATH = "data/master_ormas.xlsx"; // ganti hanya jika nama file/letak berbeda

    // ===== HEADER YANG DIDUKUNG =====
    // Kamu boleh pakai variasi nama kolom berikut. Script akan memetakan otomatis.
    const HEADER_MAP = {
      "No":["No","Nomor","ID"],
      "Nama Ormas/Lembaga":["Nama Ormas/Lembaga","Nama Ormas","Nama Lembaga","Nama"],
      "Ketua/PJ":["Ketua/PJ","Ketua","Penanggung Jawab","PJ"],
      "Kontak":["Kontak","HP","No HP","Telepon","Telp","Phone"],
      "Status":["Status","Status Aktif"],
      "Kantor/Sekretariat":["Kantor/Sekretariat","Alamat","Desa","Lokasi"],
      "Jenis/Fokus":["Jenis/Fokus","Kategori","Fokus","Jenis"],
      "Legalitas":["Legalitas","Badan Hukum"],
      "Status Pendaftaran":["Status Pendaftaran","SKT","Kemenkumham","Registrasi"],
      "Lingkup":["Lingkup","Skala","Cakupan"],
      "Metode Verifikasi":["Metode Verifikasi","Verifikasi","Sumber"],
      "Kegiatan":["Kegiatan","Aktivitas","Catatan"],
      "Latitude":["Latitude","Lat","Lintang","Koordinat Latitude"],
      "Longitude":["Longitude","Lng","Bujur","Koordinat Longitude"]
    };
    const EXPECTED_COLS = Object.keys(HEADER_MAP);

    // ===== UTIL =====
    const toNum = (x)=>{
      if(x==null) return NaN;
      const s = String(x).trim().replace(",", ".").replace(/[^0-9.\-]+/g,"");
      const v = parseFloat(s);
      return isNaN(v)?NaN:v;
    };
    const isActive = (status)=>{
      if(!status) return false;
      const s = String(status).toLowerCase();
      return s.includes("aktif") && !s.includes("tidak");
    };

    // Peta Excel -> header standar
    function normalizeRow(rowRaw){
      const row = {};
      for(const std of EXPECTED_COLS){
        const alts = HEADER_MAP[std];
        let found="";
        for(const k of Object.keys(rowRaw)){
          const key = String(k).trim();
          if(alts.some(a=>a.toLowerCase()===key.toLowerCase())){ found = key; break; }
        }
        row[std] = found ? rowRaw[found] : "";
      }
      return row;
    }

    // Group per lokasi
    function groupByLocation(rows){
      const groups = {};
      rows.forEach(r=>{
        let lat = toNum(r["Latitude"]);
        let lng = toNum(r["Longitude"]);
        // auto swap jika kebalik
        if(!isNaN(lat) && !isNaN(lng) && Math.abs(lat)>20 && Math.abs(lng)<5){ const t=lat; lat=lng; lng=t; }
        if(isNaN(lat) || isNaN(lng)) return;
        const key = lat.toFixed(5)+","+lng.toFixed(5);
        if(!groups[key]) groups[key] = {lat, lng, desa: r["Kantor/Sekretariat"]||"-", items:[]};
        groups[key].items.push(r);
      });
      return groups;
    }

    // ===== LOAD EXCEL =====
    async function loadExcel(){
      const url = EXCEL_PATH + "?v=" + Date.now(); // cache-buster
      const resp = await fetch(url);
      if(!resp.ok) throw new Error("Gagal mengambil Excel: "+resp.status);
      const buf = await resp.arrayBuffer();
      const wb = XLSX.read(buf, {type:"array"});
      const sheet = wb.Sheets[wb.SheetNames[0]];
      let rows = XLSX.utils.sheet_to_json(sheet, {defval:""});
      rows = rows.map(normalizeRow);
      return rows;
    }

    // ===== RENDER =====
    function renderBadges(rows){
      const total = rows.length;
      const aktif = rows.filter(r=>isActive(r["Status"])).length;
      const non = rows.filter(r=>(r["Status"]||"").toLowerCase().includes("tidak")).length;
      const skt = rows.filter(r=>{
        const p=(r["Status Pendaftaran"]||"").toLowerCase();
        return p.includes("skt")||p.includes("kemenkumham")||p.includes("terdaftar");
      }).length;
      const nas = rows.filter(r=>(r["Lingkup"]||"").toLowerCase().includes("nasional")).length;
      const lok = rows.filter(r=>{
        const l=(r["Lingkup"]||"").toLowerCase();
        return l.includes("lokal")||l.includes("daerah");
      }).length;
      document.getElementById("bTotal").innerText=total;
      document.getElementById("bAktif").innerText=aktif;
      document.getElementById("bNon").innerText=non;
      document.getElementById("bSKT").innerText=skt;
      document.getElementById("bNas").innerText=nas;
      document.getElementById("bLok").innerText=lok;
    }

    function renderMap(rows){
      const groups = groupByLocation(rows);
      const keys = Object.keys(groups);
      const map = L.map('map').setView([-0.3245,127.8880],10);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18,attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
      if(!keys.length){ document.getElementById('tip').classList.remove('d-none'); return; }

      const layer = L.layerGroup().addTo(map);
      const bounds = [];
      keys.forEach(k=>{
        const g = groups[k];
        const aktif = g.items.filter(i=>isActive(i["Status"])).length;
        const ratio = aktif / g.items.length;
        const pinClass = ratio>=0.6 ? "badge-pin green" : (ratio>0 ? "badge-pin red" : "badge-pin");
        const icon = L.divIcon({html:"<div class='"+pinClass+"'>"+g.items.length+"</div>",className:"",iconSize:[36,36],iconAnchor:[18,18]});
        const m = L.marker([g.lat,g.lng],{icon}).addTo(layer);
        const list = g.items.slice(0,12).map(i=>"• "+(i["Nama Ormas/Lembaga"]||"-")+" ("+(i["Status"]||"-")+")").join("<br/>");
        const more = g.items.length>12 ? "<br/><em>+"+(g.items.length-12)+" lainnya…</em>" : "";
        m.bindPopup("<strong>"+(g.desa||"Lokasi")+"</strong><br/>Koordinat: "+g.lat.toFixed(6)+", "+g.lng.toFixed(6)+"<br/>Total ormas: <strong>"+g.items.length+"</strong><hr/>"+list+more);
        bounds.push([g.lat,g.lng]);
      });
      if(bounds.length) map.fitBounds(L.latLngBounds(bounds),{padding:[20,20]});
    }

    function renderTable(rows){
      // header
      const head = document.getElementById("tblHead"); head.innerHTML="";
      EXPECTED_COLS.forEach(c=>{ const th=document.createElement("th"); th.textContent=c; head.appendChild(th); });
      // data
      const data = rows.map(r=>EXPECTED_COLS.map(c=>r[c]||""));
      $('#ormasTable').DataTable({destroy:true,data,pageLength:25,order:[[0,'asc']]});
      // isi manual karena DataTables di-init setelah, kita pakai API
      const dt = $('#ormasTable').DataTable();
      dt.clear(); dt.rows.add(data); dt.draw();
    }

    // ===== BOOT =====
    (async function(){
      try{
        const rows = await loadExcel();
        renderBadges(rows);
        renderMap(rows);
        renderTable(rows);
      }catch(e){
        console.error(e);
        document.getElementById('tip').classList.remove('d-none');
        document.getElementById('tip').classList.replace('alert-warning','alert-danger');
        document.getElementById('tip').innerHTML = "Gagal memuat Excel. Pastikan file ada di <code>"+EXCEL_PATH+"</code> di repo ini.";
      }
    })();
  </script>
</body>
</html>
